<!doctype html>
<html>

<head>
  <title>Curso Javascript Completo</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/materialize.min.css">
  <link rel="stylesheet" type="text/css" href="css/estilo.css">

</head>

<body>
    <div id="bs-feedback" class="alert alert-warning alert-dismissible" role="alert">
        <span class="content"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">X</button>
    </div>

    <div class="container">
        <h1>Digite um CEP</h1>
        <form>
            <div class="form-group">
                <label class="control-label" for="inputCEP">CEP</label>
                <div class="controls">
                    <input class="form-control" type="text" id="inputCEP" placeholder="xxxxx-xxx">
                </div>
            </div>
            <div class="form-group">
                <label class="control-label" for="inputLogradouro">Logradouro</label>
                <div class="controls">
                    <input class="form-control" type="text" id="inputLogradouro" placeholder="Logradouro">
                    <input class="form-control" type="number" id="inputNumero" placeholder="Numero">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label" for="inputBairro">Bairro</label>
                <div class="controls">
                    <input class="form-control" type="text" id="inputBairro" placeholder="Bairro">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label" for="inputLocalidade">Cidade</label>
                <div class="controls">
                    <input class="form-control" type="text" id="inputLocalidade" placeholder="Cidade">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label" for="inputUF">Estado</label>
                <div class="controls">
                    <input class="form-control" type="text" id="inputUF" placeholder="Estado">
                </div>
            </div>
        </form>
    </div>
</body>

<script>

// infos & listeners
let infos = (function(){
    let lastCEP = "";

    return {lastCEP}
})();
;(function() {
    document.getElementById("inputCEP").addEventListener("keyup",(e) => {
        if (validateCEP(e)) updateCEPinfo(e);
    })
})();

// cep handlers;

function validateCEP(event) {
    let cep = event.target.value;    
        cep = cep.replace(/[\s-]/g, "");

    if (cep.length === 8 && parseInt(cep) !== infos.lastCEP && !isNaN(cep)) return parseInt(cep);
    
    return false;
}
function requestCEP(cep,{method,url,data}){
    if (!method || !url) throw new Error("xhr request info (method or url) needs to be specified");
    
    infos.lastCEP = cep;

    return new Promise(function (resolve,reject) {
        url += `${cep}/json`;
        
        let xhr = new XMLHttpRequest();
            xhr.open(method,url);
            xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8")
            xhr.send(data);
            xhr.onreadystatechange = function handleProcess() {
                if (xhr.status < 400 && xhr.readyState === 4) {
                    let json = JSON.parse(xhr.responseText);
                    resolve(json);
                }
                if (xhr.status > 399 && xhr.readyState === 4) {
                    reject(new Error("api request failed"));
                }
            };
    })
}
function updateCEPinfo(event) {
    requestCEP(
        validateCEP(event),
        {
        method: "GET",
        url: "https://viacep.com.br/ws/",
        data: null
        }
    )
    .then((cepInfo) => {
        if (cepInfo.erro) throw new Error("Cep not found");
        return cepInfo;
    })
    .then((cepInfo) => {
        [...document.querySelectorAll("input")].forEach((input) => {
            if (!cepInfo[input.id.slice(5).toLowerCase()]) return;
            input.value = cepInfo[input.id.slice(5).toLowerCase()];
        })
    })
    .catch((e) => {throw new Error(e)});
}
</script>

</html>